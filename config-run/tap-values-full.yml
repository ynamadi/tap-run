#@ load("@ytt:data", "data")
#@ load("@ytt:yaml", "yaml")

---
#@ def config():
profile: run
ceip_policy_disclosed: true

contour:
  envoy:
    service:
      type: LoadBalancer

supply_chain: basic

cnrs:
  domain_name: #@ data.values.tap.domains.knative
  default_tls_secret: tanzu-system-ingress/tls
  domain_template: "{{.Name}}-{{.Namespace}}.{{.Domain}}"

api_auto_registration:
  tap_gui_url: https://tap-gui.tap.tanzu.y-compiles.com
  cluster_name: tap-run
  ca_cert_data:  |-
                 -----BEGIN CERTIFICATE-----
                 MIIFOjCCBCKgAwIBAgISBOnR4rWGaHL1tED3hUQx0yO4MA0GCSqGSIb3DQEBCwUA
                 MDIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MQswCQYDVQQD
                 EwJSMzAeFw0yMjEwMzExMTA3MzZaFw0yMzAxMjkxMTA3MzVaMCUxIzAhBgNVBAMM
                 GioudGFwLnRhbnp1LnktY29tcGlsZXMuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOC
                 AQ8AMIIBCgKCAQEA3PUYT9ibqhME0xSapZ70YxtgHq1z4PKb7e0X7mhwd2tXU2bo
                 fOfzMTw9CNik5r7ur7VWgsraC2YksDkzfuX4pBdhVhi+3yVijGo2qSOUFTBUYhaZ
                 0Q18a6GevZ5EmDhSHaySGjD4CSf97X2oUXLWdtCfCSyU5xmVyznZ/D3En+tmThir
                 /koNXckuOQkO6hm7eNTn5yuA5H7zNH17fgvmUzdLfP2QJfOlJVHbGjc04d/B+0Yp
                 eYp7NtauPAJaQETAq7T3pvWIo/y5NM7oUGLse6JjIkMeukxzLVh6qLlMuk4DGEB4
                 bRU3Tna4FmZQgl5iY/TFSvZVU163k5nRv3jTpwIDAQABo4ICVTCCAlEwDgYDVR0P
                 AQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAMBgNVHRMB
                 Af8EAjAAMB0GA1UdDgQWBBR871hVTu6cIcXV5SEpFE+wHKwcyjAfBgNVHSMEGDAW
                 gBQULrMXt1hWy65QCUDmH6+dixTCxjBVBggrBgEFBQcBAQRJMEcwIQYIKwYBBQUH
                 MAGGFWh0dHA6Ly9yMy5vLmxlbmNyLm9yZzAiBggrBgEFBQcwAoYWaHR0cDovL3Iz
                 LmkubGVuY3Iub3JnLzAlBgNVHREEHjAcghoqLnRhcC50YW56dS55LWNvbXBpbGVz
                 LmNvbTBMBgNVHSAERTBDMAgGBmeBDAECATA3BgsrBgEEAYLfEwEBATAoMCYGCCsG
                 AQUFBwIBFhpodHRwOi8vY3BzLmxldHNlbmNyeXB0Lm9yZzCCAQQGCisGAQQB1nkC
                 BAIEgfUEgfIA8AB2ALc++yTfnE26dfI5xbpY9Gxd/ELPep81xJ4dCYEl7bSZAAAB
                 hC3wpL0AAAQDAEcwRQIgSvbiwo40p9UcQlSxzfL0czN/PIf5Ma+9xuGTa+xgSwMC
                 IQCphMKdTaKmPNOZxv6/nj4zeB5pip3zskAyNOSL2aLR5QB2AHoyjFTYty22IOo4
                 4FIe6YQWcDIThU070ivBOlejUutSAAABhC3wpsgAAAQDAEcwRQIgSuaP6bDV+9xg
                 hxRHP5Kb4hBdQQYsDXUGMeI5O8Tdx04CIQDLo4jrvMbyZPVb+6NxGI7lNZ9ikahj
                 qZMepWSdr0HflTANBgkqhkiG9w0BAQsFAAOCAQEAqrlffycGFDVR29OraLRw6lt/
                 xyMPT+IHIRnK9LXk+OFM2SEKptFMAtrkdzlwBt5STw5369weU6R7tv/vatLNggjY
                 7TTzIgGL5cW7/cypbN0Bqp3mcNn4TQWdU9mWUGsNeuWluU3xTiPNrCn1rwzbagtT
                 f4YQozcxhG2/dJ7WFFPGE8giga/9pG3arwPcMmUYI/LYRGIZt9P6rwzIrKzAPsin
                 fhBg2pQ8pdoNsYqK1/6XkaJDXfN3+eJvBW2qYco6wak9CfEzIlLlhrQSz1QKXpK8
                 XJfnp57O0hqAK/OxOQTa/PgWtZKCeIGFlDxnI+eemnhQttPS+nOB1vAZCL1B8w==
                 -----END CERTIFICATE-----
appliveview_connector:
  backend:
    sslDisabled: false
    host: #@ data.values.tap.domains.appliveview
    ingressEnabled: true
    caCertData: |-
                -----BEGIN CERTIFICATE-----
                MIIFOjCCBCKgAwIBAgISBOnR4rWGaHL1tED3hUQx0yO4MA0GCSqGSIb3DQEBCwUA
                MDIxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MQswCQYDVQQD
                EwJSMzAeFw0yMjEwMzExMTA3MzZaFw0yMzAxMjkxMTA3MzVaMCUxIzAhBgNVBAMM
                GioudGFwLnRhbnp1LnktY29tcGlsZXMuY29tMIIBIjANBgkqhkiG9w0BAQEFAAOC
                AQ8AMIIBCgKCAQEA3PUYT9ibqhME0xSapZ70YxtgHq1z4PKb7e0X7mhwd2tXU2bo
                fOfzMTw9CNik5r7ur7VWgsraC2YksDkzfuX4pBdhVhi+3yVijGo2qSOUFTBUYhaZ
                0Q18a6GevZ5EmDhSHaySGjD4CSf97X2oUXLWdtCfCSyU5xmVyznZ/D3En+tmThir
                /koNXckuOQkO6hm7eNTn5yuA5H7zNH17fgvmUzdLfP2QJfOlJVHbGjc04d/B+0Yp
                eYp7NtauPAJaQETAq7T3pvWIo/y5NM7oUGLse6JjIkMeukxzLVh6qLlMuk4DGEB4
                bRU3Tna4FmZQgl5iY/TFSvZVU163k5nRv3jTpwIDAQABo4ICVTCCAlEwDgYDVR0P
                AQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAMBgNVHRMB
                Af8EAjAAMB0GA1UdDgQWBBR871hVTu6cIcXV5SEpFE+wHKwcyjAfBgNVHSMEGDAW
                gBQULrMXt1hWy65QCUDmH6+dixTCxjBVBggrBgEFBQcBAQRJMEcwIQYIKwYBBQUH
                MAGGFWh0dHA6Ly9yMy5vLmxlbmNyLm9yZzAiBggrBgEFBQcwAoYWaHR0cDovL3Iz
                LmkubGVuY3Iub3JnLzAlBgNVHREEHjAcghoqLnRhcC50YW56dS55LWNvbXBpbGVz
                LmNvbTBMBgNVHSAERTBDMAgGBmeBDAECATA3BgsrBgEEAYLfEwEBATAoMCYGCCsG
                AQUFBwIBFhpodHRwOi8vY3BzLmxldHNlbmNyeXB0Lm9yZzCCAQQGCisGAQQB1nkC
                BAIEgfUEgfIA8AB2ALc++yTfnE26dfI5xbpY9Gxd/ELPep81xJ4dCYEl7bSZAAAB
                hC3wpL0AAAQDAEcwRQIgSvbiwo40p9UcQlSxzfL0czN/PIf5Ma+9xuGTa+xgSwMC
                IQCphMKdTaKmPNOZxv6/nj4zeB5pip3zskAyNOSL2aLR5QB2AHoyjFTYty22IOo4
                4FIe6YQWcDIThU070ivBOlejUutSAAABhC3wpsgAAAQDAEcwRQIgSuaP6bDV+9xg
                hxRHP5Kb4hBdQQYsDXUGMeI5O8Tdx04CIQDLo4jrvMbyZPVb+6NxGI7lNZ9ikahj
                qZMepWSdr0HflTANBgkqhkiG9w0BAQsFAAOCAQEAqrlffycGFDVR29OraLRw6lt/
                xyMPT+IHIRnK9LXk+OFM2SEKptFMAtrkdzlwBt5STw5369weU6R7tv/vatLNggjY
                7TTzIgGL5cW7/cypbN0Bqp3mcNn4TQWdU9mWUGsNeuWluU3xTiPNrCn1rwzbagtT
                f4YQozcxhG2/dJ7WFFPGE8giga/9pG3arwPcMmUYI/LYRGIZt9P6rwzIrKzAPsin
                fhBg2pQ8pdoNsYqK1/6XkaJDXfN3+eJvBW2qYco6wak9CfEzIlLlhrQSz1QKXpK8
                XJfnp57O0hqAK/OxOQTa/PgWtZKCeIGFlDxnI+eemnhQttPS+nOB1vAZCL1B8w==
                -----END CERTIFICATE-----

excluded_packages:
- policy.apps.tanzu.vmware.com
#@ end
---
apiVersion: v1
kind: Secret
metadata:
  name: tap-values
  namespace: #@ data.values.tap.namespace
type: Opaque
stringData:
  values.yml: #@ yaml.encode(config())
---
apiVersion: packaging.carvel.dev/v1alpha1
kind: PackageInstall
metadata:
  name: tap
  namespace: #@ data.values.tap.namespace
  annotations:
    kapp.k14s.io/change-group: tap
    kapp.k14s.io/change-rule: "upsert after upserting tap-install/rbac"
    kapp.k14s.io/change-rule.repo: "upsert after upserting tap-install/tap-repo"
    ext.packaging.carvel.dev/ytt-paths-from-secret-name.0: "custom-labels"
spec:
  packageRef:
    refName: tap.tanzu.vmware.com
    versionSelection:
      constraints: #@ str(data.values.tap.version)
      prereleases: {}
  serviceAccountName: tap-default-sa
  values:
  - secretRef:
      name: tap-values
---
apiVersion: v1
kind: Secret
metadata:
  name: custom-labels
  namespace: #@ data.values.tap.namespace
stringData:
  add-custom-labels.yml: |
    #@ load("@ytt:overlay", "overlay")
    
    #@overlay/match by=overlay.subset({"kind":"PackageInstall"}),expects="1+"
    ---
    metadata:
      #@overlay/match missing_ok=True
      annotations:
        #@overlay/match missing_ok=True
        ext.packaging.carvel.dev/ytt-paths-from-secret-name.0: my-custom-labels
    
    ---
    apiVersion: v1
    kind: Secret
    metadata:
      name: my-custom-labels
    stringData:
      add-my-custom-labels.yml: |
        #@ load("@ytt:overlay", "overlay")
    
        #@overlay/match by=overlay.subset({"kind": "Namespace"}),expects="0+"
        ---
        metadata:
          #@overlay/match missing_ok=True
          labels:
            #@overlay/match missing_ok=True
            istio-injection: "false"
            #@overlay/match missing_ok=True
            tmc-policy: "false"
